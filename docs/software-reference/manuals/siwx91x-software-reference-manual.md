# SiWx917 SoC Programming Reference


## SoC Overview
SiWx917 SoC is the industry's first Wireless MCU family with a comprehensive multi-protocol wireless sub-system. It has an integrated ultra-low-power microcontroller, a built-in wireless subsystem, advanced security, high-performance mixed-signal peripherals, and integrated power management.

SiWx917 SoC comprises of **2** processing cores,

 * Wireless Processor - NWP (TA)
 * Application Processor - MCU (Cortex-M4)

It can operate with either two flash memories one for App Processor and other for NWP or with a shared flash. There is a shared SRAM used by both the processors. NWP provides support for inbuilt network and wireless stacks. These are accessed by an application running on App Processor via pre defined apis provided as part of wireless sdk. Both the processors are connected over AHB interface. Functioning in both M4 and TA is achieved via state machines present in application firmware and TA firmware. But TA firmware is given as a binary to users.

This document is for the developers, developing the solutions with the SiWx917SoC product line. It is intended to provide all the details required for a smooth developer experience. For information on how to get started, refer to the **'Getting Started with SiWx917 in SoC Mode'**

**Note:**
RTOS support is available at Application and Service level. Applications developers should ensure to use right RTOS primitives when accessing MCU peripherals from multiple SW threads.When using RTOS, need to configure interrupt priorities for all MCU interrupts being used in the application.


## Software Architecture
 This section gives a brief description about software components present in SiWx917 SoC SDK. This is provided in the form of source code in C along with example applications which consists of Cloud SDKs, Services like Sensor Hub, MCU Peripheral library, Wireless library and low level platform drivers. This is leveraged to customer completely for development of their application. NWP software will be provided as a binary. Both the software can be compiled and generate .rps file which can be flashed to MCU and NWP respectively.

The below diagram illustrates the architecture,

![Software Architecture Diagram](./resources/Si917.png)


## SiWx917 MCU
The SiWx917 include ARM® Cortex®-M4 processor for user application. The Cortex-M4 processor is a high performance 32-bit processor which can operate up to 180MHz. This has got rich set of core  peripherals like Systick timer, FPU, NVIC etc.

SiWx917 SDK provides CMSIS supported driver for a few peripherals

Below diagram shows CMSIS and Non-CMSIS peripherals in different blocks. This also shows MCU ULP peripherals highlighted.

For more details on MCU Peripherals, refer to SiWx917 Hardware Reference Manual 

![SiWx917 MCU Architecture](./resources/SiWx917_MCU.png)


## Boot up Flow
This section describes the SiWx917 module boot up flow till application gets the execution control.

SiWx917 possess two Bootloaders, Security Bootloader and Application Bootloader. Security Bootloader is part of TASS ROM and Application Bootloader is part of M4SS ROM. Secure Boot is implemented in Security Bootloader.

Up on reset, the Security Bootloader configures the module hardware based on the configuration present in the EFUSE and FLASH. Flash configurations are authenticated before being consumed by the Security Bootloader. It also passes the required information from the EFUSE to the Application Bootloader. The Security Bootloader validates the integrity and authenticity of the firmware in the Flash and invokes the Application Bootloader. It detects and prevents execution of unauthorized software during the boot sequence. The Bootloader uses public & private key based digital signatures to recognize authentic software.
![TA and M4 bootloader flow](./resources/boot_up_flow.png)


## SDK Programming Model
##  Application Flow

Below diagram demonstrates the SiWx917 SoC application code flow.

Code blocks in GREEN represent MCU and code blocks on ORANGE represents Wireless APIs.

![Application Flow](./resources/application_flow.png)

## Clock Configuration
The Clock Architecture describes how to configure the on-chip clocks (ULP Clock Oscillators, High-Frequency PLL) and the clocks to Processor, High Speed Interfaces, and Peripherals (includes MCU HP, MCU ULP and UULP Vbat). The Clock subsystem enables the software to vary the clock source/frequency for different functionalities to achieve lower power consumption based on the application.

* Multiple high frequency clocks generated by PLLs
  * High Frequency Clock from 1MHz - 180MHz (SOC_PLL_CLK)
  * High Frequency Interface Clock from 1MHz - 180MHz (INTF_PLL_CLK)
  * Defined frequencies for I2S Interface (I2S_PLL_CLK)

* Multiple clocks generated by ULP Clock Oscillators. These are low-power clock oscillators
  * External Crystal clock (XTAL_CLK)
  * RC 32MHz Clock (RC_32MHZ_CLK)
  * RO High-Frequency clock (RO_HF_CLK)
  * Doubler Clock (DOUBLER_CLK)
  * RC 32kHz Clock (RC_32KHZ_CLK)
  * RO 32kHz Clock (RO_32KHZ_CLK)
  * XTAL 32kHz clock (XTAL_32KHZ_CLK)

* Configurable independent division factors for varying the frequencies of different functional blocks

* Configurable independent clock gating for different functional blocks

By deafult MCU clock is configured to 32MHZ using the **RC_32MHZ_CLK** clock source.

For more details on the Clock APIs, please refer to section 'SAPI Reference > SiWx917 SoC APIs > SoC Clock APIs' in **SAPI Reference Guide**.

**SOC-Clock Configuration Example :**
To Set SOCPLL  clock (1Mhz to 180Mhz) as MCUSOC-Clock ,configure like below 
```C

//!Default keep M4 in reference clock 
RSI_CLK_M4SocClkConfig(M4CLK, M4_ULPREFCLK, 0);  

//! Enable fre-fetch and register if SOC-PLL frequency is more than or equal to 120 
#if (PLL_OUT_FREQUENCY >= 120000000)
  //!Configure the prefetch and registering when SOC clock is more than 120Mhz
  ICACHE2_ADDR_TRANSLATE_1_REG = BIT(21); //Icache registering when clk freq more than 120
 
  //!When set, enables registering in M4-TA AHB2AHB. This will have performance penalty. 
  //!This has to be set above 100MHz
  MISC_CFG_SRAM_REDUNDANCY_CTRL = BIT(4);
  MISC_CONFIG_MISC_CTRL1 |= BIT(4);  
  MISC_QUASI_SYNC_MODE |= BIT(6);

  //!Enable Inter subsystem memory Registering as m4_soc_clk clock is going to tass
  MISC_QUASI_SYNC_MODE |= (BIT(6) | BIT(7));
#endif

 //! Program PLL_OUT_FREQUENCY as 180MHZ
 #define PLL_OUT_FREQUENCY   180000000

 //!PLL_REFERENCE_FREQUENCY should be 40MHZ. Not recommended to change
 #define PLL_REFERENCE_FREQUENCY 40000000

 //!Configure the PLL frequency
 RSI_CLK_SetSocPllFreq(M4CLK, PLL_OUT_FREQUENCY, PLL_REFERENCE_FREQUENCY);  

 //!Switch M4 Core clock to SOCPLL  
 RSI_CLK_M4SocClkConfig(M4CLK, M4_SOCPLLCLK, 0);   
```   
**SOC-Clock Output on GPIO Snippet:**

After configuring above SOC-Clock Configuration snippet add below snippet for measuring the clock frequency 

```C
#define PLL_OUT_FREQUENCY   180000000
//!pad selection
sl_si91x_gpio_enable_pad_selection(3);
 
//!Enable PAD Receive enable
sl_si91x_gpio_enable_pad_receiver(GPIO_12);

//!Configure the GPIO pin mux to MCU clock Out ,and observe clock on GPIO 12
sl_gpio_set_pin_mode(0, GPIO_12, EGPIO_PIN_MUX_MODE8, 0);  

#if (PLL_OUT_FREQUENCY >= 120000000)   
  //!Enable MCU clock OUT divide/2
  RSI_CLK_McuClkOutConfig(M4CLK, MCUCLKOUT_SOC_PLL_CLK, 1);
#else   
  //!Enable MCU clock OUT divide/1 
  RSI_CLK_McuClkOutConfig(M4CLK, MCUCLKOUT_SOC_PLL_CLK, 0);
#endif

```   

## GPIO Configuration

There are total of 53 GPIOs present in SiWx917 SoC. The number of GPIOs available varies between different packages. Please refer to GPIO available vs package table in the product datasheet for more details. Registers for GPIO pins that are not available on package are reserved. 

For configuring any GPIO on SiWx917 SoC, it is required to program the following,

* Pad Configurations
*Pin Muxing

## Pad Configurations
There are multiple processor sub-systems containing SZP (Secure Zone Processor), MCU HP (High Performance) and MCU ULP (Ultra Low Power) which share these common set of GPIO pads. These GPIO pads are controllable by either SZP, MCU HP or MCU ULP. PAD selection register has to be programmed to control the GPIOs between the subsystems. 

The list below provides the registers to be configured for accessing any of the GPIOs to MCU HP,

* PAD selection Register
* PAD configuration Register
* GPIO mode Register
Refer to section 'SiWx917 Pad Configurations' in **SiWx917 Hardware Reference Manual** for complete details.

## Pin Muxing
The Pin MUX block supports many peripherals including digital and analog like I2C, I2S, UART, SPI, Ethernet, SDIO, SDMEM, PWM, QEI, CAN etc. However number of pins that can be exposed out is limited. This pin multiplexing module solves problem of accommodating all these multiple peripherals in smallest package without compromising any features. It multiplexes different functions on same I/O pins. Each I/O pin supports multiple peripheral functions. If a I/O pin is used for a peripheral function, it cannot be used as GPIO. At a time only one function can be used. The reset value for the GPIO mode of each of the GPIOs are provided in PAD Configurations section.

Refer to section 'SiWx917 Pin MUX' in **SiWx917 Hardware Reference Manual** for complete details.

**GPIO Toggle Code Snippet :**

```C
#define PORT        0
#define GPIO_PIN    GPIO_6
#define PAD_NUM     1
   
//!Enable pad section bit for GPIO 6
sl_si91x_gpio_enable_pad_selection(PAD_NUM);
  
//!Set GPIO mode to mode 0
sl_gpio_set_pin_mode(PORT, GPIO_PIN, EGPIO_PIN_MUX_MODE0,0);

//!Set GPIO to output direction 
sl_si91x_gpio_set_pin_direction(PORT, GPIO_PIN, EGPIO_CONFIG_DIR_OUTPUT);

//!Set GPIO pin value to 0
sl_gpio_clear_pin_output(PORT, GPIO_PIN);
     
//!Set GPIO pin value to 1
sl_gpio_set_pin_output(PORT, GPIO_PIN);
```   
>NOTE: Please refer GPIO Example located in example folder **sl_si91x_gpio** for further details.

**Configuring GPIO In Peripheral Mode :**
```C
/*Example for configuring GPIO6 in UART2_RX(mode 6)*/
#define PORT        0
#define GPIO_PIN    GPIO_6
#define PAD_NUM     1
   
//!Enable pad section bit for GPIO 6
sl_si91x_gpio_enable_pad_selection(PAD_NUM);
  
//!Receiver Enable for RX pin 
sl_si91x_gpio_enable_pad_receiver(GPIO_PIN);

//!Set GPIO mode to mode 0
sl_gpio_set_pin_mode(PORT, GPIO_PIN, EGPIO_PIN_MUX_MODE6,0);

```   

# 917 B0 Pin Multiplexing
There is a provision in 917, to configure SoC GPIO as ULP GPIO and ULP_GPIO as SoC GPIO to achieve desired pin functionality. 

## SoC GPIO's
The SoC GPIOs below (GPIO_6 to GPIO_51) are available in the normal mode of operation (Power-states 4 and 3). For a description of power-states, refer to the Hardware Reference Manual. Each of these GPIO's Pin function is controlled by the GPIO Mode register mentioned in SoC GPIO's section of the Hardware Reference Manual. 


| **PIN** | **PAD NUMBER** | **GPIO** | **GPIO Mode= 0** | **GPIO Mode= 1** | **GPIO Mode= 2** | **GPIO Mode= 3** | **GPIO Mode= 4** | **GPIO Mode= 5** | **GPIO Mode= 6** | **GPIO Mode= 7** | **GPIO Mode= 8** | **GPIO Mode= 9** | **GPIO Mode= 10** | **GPIO Mode= 11** | **GPIO Mode= 12** | **GPIO Mode*= 13** | **GPIO Mode*= 14** | **GPIO Mode*= 15** |
| ------- | -------------- | ---------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | -------------------------- | -------------------------- | -------------------------- | -------------------------- | -------------------------- | -------------------------- |
| 6 | 1 | GPIO_6 | GPIO_6 | SIO_0 | USART1_CTS | SSI_MST_DATA2 | I2C1_SDA | I2C2_SCL | UART2_RX | I2S_2CH_DIN_1 | PMU_TEST_1 | ULPPERH_ON_SOC_GPIO_0 | PWM_1L | M4SS_QSPI_D0 | GSPI_MST1_MOS1 | M4SS_TRACE_CLKIN |  | NWP_GPIO_6 |
| 7 | 2 | GPIO_7 | GPIO_7 | SIO_1 | USART1_DTR | SSI_MST_DATA3 | I2C1_SCL | I2C2_SDA | UART2_TX | I2S_2CH_DOUT_1 | PMU_TEST_2 | ULPPERH_ON_SOC_GPIO_1 | PWM_1H | M4SS_QSPI_CSN0 | M4SS_QSPI_CSN1 | M4SS_TRACE_CLK |  |  |
| 8 | 3 | GPIO_8 | GPIO_8 | SIO_2 | USART1_CLK | SSI_MST_CLK | GSPI_MST1_CLK | QEI_IDX | UART2_RS485_RE | I2S_2CH_CLK | SSI_SLV_CLK | ULPPERH_ON_SOC_GPIO_2 | PWM_2L | M4SS_QSPI_CLK | SCT_OUT_2 | M4SS_TRACE_D0 |  | NWP_GPIO_8 |
| 9 | 4 | GPIO_9 | GPIO_9 | SIO_3 | USART1_RTS | SSI_MST_CS0 | GSPI_MST1_CS0 | QEI_PHA | UART2_RS485_DE | I2S_2CH_WS | SSI_SLV_CS |  | PWM_2H | M4SS_QSPI_D1 | SCT_OUT_3 | M4SS_TRACE_D1 |  | NWP_GPIO_9 |
| 10 | 5 | GPIO_10 | GPIO_10 | SIO_4 | USART1_RX | SSI_MST_CS1 | GSPI_MST1_CS1 | QEI_PHB | UART2_RTS | I2S_2CH_DIN_0 | SSI_SLV_MOSI | ULPPERH_ON_SOC_GPIO_4 | PWM_3L | M4SS_QSPI_D2 | SSI_MST_DATA1 | M4SS_TRACE_D2 |  | NWP_GPIO_10 |
| 11 | 6 | GPIO_11 | GPIO_11 | SIO_5 | USART1_DSR | SSI_MST_DATA0 | GSPI_MST1_MISO | QEI_DIR | UART2_CTS | I2S_2CH_DOUT_0 | SSI_SLV_MISO | ULPPERH_ON_SOC_GPIO_5 | PWM_3H | M4SS_QSPI_D3 | MCU_CLK_OUT | M4SS_TRACE_D3 |  | NWP_GPIO_11 |
| 12 | 7 | GPIO_12 | GPIO_12 |  | USART1_DCD | SSI_MST_DATA1 | GSPI_MST1_MOSI |  | UART2_RS485_EN |  | MCU_CLK_OUT | ULPPERH_ON_SOC_GPIO_6 | PWM_4L |  |  |  |  | NWP_GPIO_12 |
| 15 | 8 | GPIO_15 | GPIO_15 | SIO_7 | UART2_TX | SSI_MST_CS2 | GSPI_MST1_CS2 |  | M4SS_TRACE_CLKIN |  | MCU_CLK_OUT | ULPPERH_ON_SOC_GPIO_7 | PWM_4H |  |  |  |  | NWP_GPIO_15 |
| 25 | No need to select the Pad | GPIO_25 | GPIO_25 | SIO_0 | USART1_CLK | SSI_MST_CLK | GSPI_MST1_CLK | QEI_IDX |  | I2S_2CH_CLK | SSI_SLV_CS | SCT_IN_0 | PWM_FAULTA | ULPPERH_ON_SOC_GPIO_6 | SOC_PLL_CLOCK | USART1_IR_RX | TopGPIO_0 |  |
| 26 | No need to select the Pad | GPIO_26 | GPIO_26 | SIO_1 | USART1_CTS | SSI_MST_DATA0 | GSPI_MST1_MISO | QEI_PHA | UART2_RS485_EN | I2S_2CH_WS | SSI_SLV_CLK | SCT_IN_1 | PWM_FAULTB | ULPPERH_ON_SOC_GPIO_7 | INTERFACE_PLL_CLOCK | USART1_IR_TX | TopGPIO_1 |  |
| 27 | No need to select the Pad | GPIO_27 | GPIO_27 | SIO_2 | USART1_RI | SSI_MST_DATA1 | GSPI_MST1_MOSI | QEI_PHB | UART2_RTS | I2S_2CH_DIN_0 | SSI_SLV_MOSI | SCT_IN_2 | PWM_TMR_EXT_TRIG_1 | ULPPERH_ON_SOC_GPIO_8 | I2S_PLL_CLOCK | USART1_RS485_EN | TopGPIO_2 |  |
| 28 | No need to select the Pad | GPIO_28 | GPIO_28 | SIO_3 | USART1_RTS | SSI_MST_CS0 | GSPI_MST1_CS0 | QEI_DIR | UART2_RTS | I2S_2CH_DOUT_0 | SSI_SLV_MISO | SCT_IN_3 | PWM_TMR_EXT_TRIG_2 | ULPPERH_ON_SOC_GPIO_9 | XTAL_ON_IN | USART1_RS485_RE | TopGPIO_3 |  |
| 29 | No need to select the Pad | GPIO_29 | GPIO_29 | SIO_4 | USART1_RX | SSI_MST_DATA2 | GSPI_MST1_CS1 | I2C2_SCL | UART2_RX | I2S_2CH_DIN_1 | PMU_TEST_1 | SCT_OUT_0 | PWM_TMR_EXT_TRIG_3 | ULPPERH_ON_SOC_GPIO_10 | USART1_DCD | USART1_RS485_DE | TopGPIO_4 |  |
| 30 | No need to select the Pad | GPIO_30 | GPIO_30 | SIO_5 | USART1_TX | SSI_MST_DATA3 | GSPI_MST1_CS2 | I2C2_SDA | UART2_TX | I2S_2CH_DOUT_1 | PMU_TEST_2 | SCT_OUT_1 | PWM_TMR_EXT_TRIG_4 | ULPPERH_ON_SOC_GPIO_11 | PMU_TEST_1 | PMU_TEST_2 | TopGPIO_5 |  |
| 31 | 9 | GPIO_31 | GPIO_31 |  |  |  |  |  |  |  |  |  |  | I2C1_SDA | UART2_RTS | QEI_IDX |  |  |
| 32 | 9 | GPIO_32 | GPIO_32 |  |  |  |  |  |  |  |  |  |  | I2C1_SCL | UART2_CTS | QEI_PHA |  |  |
| 33 | 9 | GPIO_33 | GPIO_33 |  |  |  |  |  |  |  |  |  |  | I2C2_SCL | UART2_RX | QEI_PHB |  |  |
| 34 | 9 | GPIO_34 | GPIO_34 |  |  |  |  |  |  |  |  |  |  | I2C2_SDA | UART2_TX | QEI_DIR |  |  |
| 46 | 10 | GPIO_46 | GPIO_46 | M4SS_QSPI_CLK | USART1_RI | QEI_IDX | GSPI_MST1_CLK |  | M4SS_TRACE_CLKIN | I2S_2CH_CLK | SSI_SLV_CS | ULPPERH_ON_SOC_GPIO_8 | SOC_PLL_CLOCK | M4SS_PSRAM_CLK |  |  |  | NWP_GPIO_46 |
| 47 | 11 | GPIO_47 | GPIO_47 | M4SS_QSPI_D0 | USART1_IR_RX | QEI_PHA | GSPI_MST1_MISO |  | M4SS_TRACE_CLK | I2S_2CH_WS | SSI_SLV_CLK | ULPPERH_ON_SOC_GPIO_9 | INTERFACE_PLL_CLOCK | M4SS_PSRAM_D0 |  |  |  | NWP_GPIO_47 |
| 48 | 12 | GPIO_48 | GPIO_48 | M4SS_QSPI_D1 | USART1_IR_TX | QEI_PHB | GSPI_MST1_MOSI |  | M4SS_TRACE_D0 | I2S_2CH_DIN_0 | SSI_SLV_MOSI | ULPPERH_ON_SOC_GPIO_10 | I2S_PLL_CLOCK | M4SS_PSRAM_D1 |  |  |  | NWP_GPIO_48 |
| 49 | 13 | GPIO_49 | GPIO_49 | M4SS_QSPI_CSN0 | USART1_RS485_EN | QEI_DIR | GSPI_MST1_CS0 |  | M4SS_TRACE_D1 | I2S_2CH_DOUT_0 | SSI_SLV_MISO | ULPPERH_ON_SOC_GPIO_11 | MCU_QSPI_CSN0 | M4SS_PSRAM_CSN0 |  |  |  | NWP_GPIO_49 |
| 50 | 14 | GPIO_50 | GPIO_50 | M4SS_QSPI_D2 | USART1_RS485_RE | SSI_MST_CS2 | GSPI_MST1_CS1 | I2C2_SCL | M4SS_TRACE_D2 | I2S_2CH_DIN_1 | PWM_TMR_EXT_TRIG_4 | UART2_RTS | MEMS_REF_CLOCK | M4SS_PSRAM_D2 |  |  |  | NWP_GPIO_50 |
| 51 | 15 | GPIO_51 | GPIO_51 | M4SS_QSPI_D3 | USART1_RS485_DE | SSI_MST_CS3 | GSPI_MST1_CS2 | I2C2_SDA | M4SS_TRACE_D3 | I2S_2CH_DOUT_1 | PWM_TMR_EXT_TRIG_1 | UART2_CTS | PLL_TESTMODE_SIG | M4SS_PSRAM_D3 |  |  |  | NWP_GPIO_51 |
| 52 | 16 | GPIO_52 | GPIO_52 |  | USART1_CLK | SSI_MST_CLK | GSPI_MST1_CLK | QEI_IDX | M4SS_TRACE_CLKIN | I2S_2CH_CLK | SSI_SLV_CLK | M4SS_QSPI_CLK | SOC_PLL_CLOCK |  | M4SS_PSRAM_CLK |  |  |  |
| 53 | 17 | GPIO_53 | GPIO_53 | M4SS_QSPI_CSN1 | USART1_RTS | SSI_MST_CS0 | GSPI_MST1_CS0 | QEI_PHA | M4SS_TRACE_CLK | I2S_2CH_WS | SSI_SLV_CS | M4SS_QSPI_D0 | INTERFACE_PLL_CLOCK | M4SS_PSRAM_CSN1 | M4SS_PSRAM_D0 |  |  |  |
| 54 | 18 | GPIO_54 | GPIO_54 | M4SS_QSPI_D4 | USART1_TX | SSI_MST_DATA2 | GSPI_MST1_CS1 | I2C2_SCL | M4SS_TRACE_D0 | I2S_2CH_DIN_1 | PWM_TMR_EXT_TRIG_2 | M4SS_QSPI_D1 | I2S_PLL_CLOCK | M4SS_PSRAM_D4 | M4SS_PSRAM_D1 |  |  |  |
| 55 | 19 | GPIO_55 | GPIO_55 | M4SS_QSPI_D5 | USART1_RX | SSI_MST_DATA3 | GSPI_MST1_CS2 | I2C2_SDA | M4SS_TRACE_D1 | I2S_2CH_DOUT_1 | PWM_TMR_EXT_TRIG_3 | M4SS_QSPI_CSN0 |  | M4SS_PSRAM_D5 | M4SS_PSRAM_CSN0 |  |  |  |
| 56 | 20 | GPIO_56 | GPIO_56 | M4SS_QSPI_D6 | USART1_CTS | SSI_MST_DATA0 | GSPI_MST1_MISO | QEI_PHB | M4SS_TRACE_D2 | I2S_2CH_DIN_0 | SSI_SLV_MOSI | M4SS_QSPI_D2 | MEMS_REF_CLOCK | M4SS_PSRAM_D6 | M4SS_PSRAM_D2 |  |  |  |
| 57 | 21 | GPIO_57 | GPIO_57 | M4SS_QSPI_D7 | USART1_DSR | SSI_MST_DATA1 | GSPI_MST1_MOSI | QEI_DIR | M4SS_TRACE_D3 | I2S_2CH_DOUT_0 | SSI_SLV_MISO | M4SS_QSPI_D3 | XTAL_ON_IN | M4SS_PSRAM_D7 | M4SS_PSRAM_D3 |  |  |  |


**SDK API's for configuring SoC GPIO's:**

```C
   /* This API is used to bring the control of GPIO to M4 */
   sl_si91x_gpio_enable_pad_selection(PIN); 
   /* This API is used to set MODE for SoC GPIO */
   sl_gpio_set_pin_mode(PORT0, PIN, _MODE, OUTPUT_VALUE); 
   /* This API is used to set direction if MODE is configured as 0 using the sl_gpio_set_pin_mode() API, DIR is 0 for OUTPUT, 1 for INPUT */
   sl_si91x_gpio_set_pin_direction(PORT0, PIN, DIR);
   /* This API is used to set reception enable if the pin is an INPUT */
   sl_si91x_gpio_enable_pad_receiver(PIN);  

Example:

   /*Enable PAD for GPIO_10*/
   sl_si91x_gpio_enable_pad_selection(5);
   /*Configuring GPIO_10 MODE as GPIO */
   sl_gpio_set_pin_mode(0, 10, 0 );
   /*Set GPIO_10 direction as OUTPUT*/
   sl_si91x_gpio_set_pin_direction(0, 10, 0);

```

## Digital Functions for virtual ULP GPIOs

From the above mux table of SoC GPIO, few of the SoC GPIO's can be configured as ULP_GPIO's by configuring MODE9/MODE11 in GPIO Mode register(This means ULP functionality can be achieved on the physical SoC GPIO PIN). Refer to the table below for ULP functionality mux options on the SoC GPIO's that are converted to ULP_GPIO's. The ULP GPIOs below (ULPPERH_ON_SOC_GPIO_0 to ULPPERH_ON_SOC_GPIO_11) are available in the normal mode of operation (Power-states 4 and 3). For a description of power-states, refer to the Hardware Reference Manual. Each of these GPIO's Pin function is controlled by the Special function ULP register mentioned in ULP GPIO's section of the Hardware Reference Manual.

| PIN | ULP_GPIO | ULP_GPIO Mode 0 | ULP_GPIO Mode 1 | ULP_GPIO Mode 2 | ULP_GPIO Mode 3 | ULP_GPIO Mode 4 | ULP_GPIO Mode 5 | ULP_GPIO Mode 6 | ULP_GPIO Mode 7 | ULP_GPIO Mode 8 | ULP_GPIO Mode 9 | ULP_GPIO Mode 10 | ULP_GPIO Mode 11 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0 | ULPPERH_ON_SOC_GPIO_0 | ULP_EGPIO[0] | ULP_SPI_CLK | ULP_I2S_DIN | ULP_UART_RTS | ULP_I2C_SDA | NPSS_GPIO_1 |  |  |  |  |  |  |
| 1 | ULPPERH_ON_SOC_GPIO_1 | ULP_EGPIO[1] | ULP_SPI_DOUT | ULP_I2S_DOUT | ULP_UART_CTS | ULP_I2C_SCL | Timer0 |  |  |  |  |  |  |
| 2 | ULPPERH_ON_SOC_GPIO_2 | ULP_EGPIO[2] | ULP_SPI_DIN | ULP_I2S_WS | ULP_UART_RX | NPSS_GPIO_4 | COMP1_OUT |  |  |  |  |  |  |
| 4 | ULPPERH_ON_SOC_GPIO_4 | ULP_EGPIO[4] | ULP_SPI_CS1 | ULP_I2S_WS | ULP_UART_RTS | ULP_I2C_SDA | NPSS_GPIO_4 | NPSS_TEST_MODE_1 |  | ULP_SPI_CLK | Timer0 | IR_INPUT | NPSS_GPIO_2 |
| 5 | ULPPERH_ON_SOC_GPIO_5 | ULP_EGPIO[5] | IR_OUTPUT | ULP_I2S_DOUT | ULP_UART_CTS | ULP_I2C_SCL | AUX_ULP_TRIG_0 | NPSS_TEST_MODE_2 |  | ULP_SPI_DOUT | Timer1 | IR_OUTPUT | NPSS_GPIO_3 |
| 6 | ULPPERH_ON_SOC_GPIO_6 | ULP_EGPIO[6] | ULP_SPI_CS2 | ULP_I2S_DIN | ULP_UART_RX | ULP_I2C_SDA | NPSS_GPIO_1 | NPSS_GPIO_0 |  | ULP_SPI_DIN | COMP1_OUT | AUX_ULP_TRIG_0 | NPSS_GPIO_4 |
| 7 | ULPPERH_ON_SOC_GPIO_7 | ULP_EGPIO[7] | IR_INPUT | ULP_I2S_CLK | ULP_UART_TX | ULP_I2C_SCL | Timer1 | NPSS_GPIO_1 |  | ULP_SPI_CS0 | COMP2_OUT | AUX_ULP_TRIG_1 | NPSS_TEST_MODE_0 |
| 8 | ULPPERH_ON_SOC_GPIO_8 | ULP_EGPIO[8] | ULP_SPI_CLK | ULP_I2S_CLK | ULP_UART_CTS | ULP_I2C_SCL | Timer0 | NPSS_GPIO_2 |  |  |  |  |  |
| 9 | ULPPERH_ON_SOC_GPIO_9 | ULP_EGPIO[9] | ULP_SPI_DIN | ULP_I2S_DIN | ULP_UART_RX | ULP_I2C_SDA | COMP1_OUT | NPSS_GPIO_3 |  |  |  |  |  |
| 10 | ULPPERH_ON_SOC_GPIO_10 | ULP_EGPIO[10] | ULP_SPI_CS0 | ULP_I2S_WS | ULP_UART_RTS | IR_INPUT | NPSS_GPIO_4 | NPSS_TEST_MODE_0 |  |  |  |  |  |
| 11 | ULPPERH_ON_SOC_GPIO_11 | ULP_EGPIO[11] | ULP_SPI_DOUT | ULP_I2S_DOUT | ULP_UART_TX | ULP_I2C_SDA | AUX_ULP_TRIG_0 | NPSS_GPIO_4 |  |  |  |  |  |

## ULP GPIO's

The ULP GPIOs listed in the table below (ULP_GPIO_0 to ULP_GPIO_11) are available in the normal mode of operation (Power-states 4 and 3) and also in Ultra-low power mode of operation of the Microcontroller (Power-states 2 and 1). For a description of power-states, refer to the Hardware Reference Manual. Each of these GPIO's Pin function is controlled by the GPIO Mode register mentioned in ULP GPIO's section of the Hardware Reference Manual.

| PIN | ULP_GPIO | ULP_GPIO Mode 0 | ULP_GPIO Mode 1 | ULP_GPIO Mode 2 | ULP_GPIO Mode 3 | ULP_GPIO Mode 4 | ULP_GPIO Mode 5 | ULP_GPIO Mode 6 | ULP_GPIO Mode 7 | ULP_GPIO Mode 8 | ULP_GPIO Mode 9 | ULP_GPIO Mode 10 | ULP_GPIO Mode 11 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0 | ULP_GPIO_0 | ULP_EGPIO[0] | ULP_SPI_CLK | ULP_I2S_DIN | ULP_UART_RTS | ULP_I2C_SDA | NPSS_GPIO_1 | SOCPERH_ON_ULP_GPIO_0 | AGPIO_0 |  |  |  |  |
| 1 | ULP_GPIO_1 | ULP_EGPIO[1] | ULP_SPI_DOUT | ULP_I2S_DOUT | ULP_UART_CTS | ULP_I2C_SCL | Timer2 | SOCPERH_ON_ULP_GPIO_1 | AGPIO_1 |  |  |  |  |
| 2 | ULP_GPIO_2 | ULP_EGPIO[2] | ULP_SPI_DIN | ULP_I2S_WS | ULP_UART_RX | NPSS_GPIO_4 | COMP1_OUT | SOCPERH_ON_ULP_GPIO_2 | AGPIO_2 |  |  |  |  |
| 4 | ULP_GPIO_4 | ULP_EGPIO[4] | ULP_SPI_CS1 | ULP_I2S_WS | ULP_UART_RTS | ULP_I2C_SDA | AUX_ULP_TRIG_1 | SOCPERH_ON_ULP_GPIO_4 | AGPIO_4 | ULP_SPI_CLK | Timer0 | IR_INPUT | NPSS_GPIO_2 |
| 5 | ULP_GPIO_5 | ULP_EGPIO[5] | IR_OUTPUT | ULP_I2S_DOUT | ULP_UART_CTS | ULP_I2C_SCL | AUX_ULP_TRIG_0 | SOCPERH_ON_ULP_GPIO_5 | AGPIO_5 | ULP_SPI_DOUT | Timer1 | IR_OUTPUT | NPSS_GPIO_3 |
| 6 | ULP_GPIO_6 | ULP_EGPIO[6] | ULP_SPI_CS2 | ULP_I2S_DIN | ULP_UART_RX | ULP_I2C_SDA | NPSS_GPIO_1 | SOCPERH_ON_ULP_GPIO_6 | AGPIO_6 | ULP_SPI_DIN | COMP1_OUT | AUX_ULP_TRIG_0 | NPSS_GPIO_4 |
| 7 | ULP_GPIO_7 | ULP_EGPIO[7] | IR_INPUT | ULP_I2S_CLK | ULP_UART_TX | ULP_I2C_SCL | Timer1 | SOCPERH_ON_ULP_GPIO_7 | AGPIO_7 | ULP_SPI_CS0 | COMP2_OUT | AUX_ULP_TRIG_1 | NPSS_TEST_MODE_0 |
| 8 | ULP_GPIO_8 | ULP_EGPIO[8] | ULP_SPI_CLK | ULP_I2S_CLK | ULP_UART_CTS | ULP_I2C_SCL | Timer0 | SOCPERH_ON_ULP_GPIO_8 | AGPIO_8 |  |  |  |  |
| 9 | ULP_GPIO_9 | ULP_EGPIO[9] | ULP_SPI_DIN | ULP_I2S_DIN | ULP_UART_RX | ULP_I2C_SDA | NPSS_TEST_MODE_0 | SOCPERH_ON_ULP_GPIO_9 | AGPIO_9 |  |  |  |  |
| 10 | ULP_GPIO_10 | ULP_EGPIO[10] | ULP_SPI_CS0 | ULP_I2S_WS | ULP_UART_RTS | IR_INPUT | NPSS_GPIO_4 | SOCPERH_ON_ULP_GPIO_10 | AGPIO_10 |  |  |  |  |
| 11 | ULP_GPIO_11 | ULP_EGPIO[11] | ULP_SPI_DOUT | ULP_I2S_DOUT | ULP_UART_TX | ULP_I2C_SDA | AUX_ULP_TRIG_0 | SOCPERH_ON_ULP_GPIO_11 | AGPIO_11 |  |  |  |  |

**3.0 SDK API's for configuring ULP GPIO's :**

```C
   /* This API is used to set MODE for SoC GPIO */
   sl_gpio_set_pin_mode(4, PIN, _MODE, OUTPUT_VALUE); 
   /* This API is used to set direction if MODE is configured as 0 using the sl_gpio_set_pin_mode() API, DIR is 0 for OUTPUT, 1 for INPUT */
   sl_si91x_gpio_set_pin_direction(4, PIN, DIR);
   /* This API is used to set reception enable if the pin is an INPUT */
   sl_si91x_gpio_enable_ulp_pad_receiver(PIN);  

Example:

   /*Configuring GPIO_10 MODE as GPIO */
   sl_gpio_set_pin_mode(4, 10, 0, );
   /*Set GPIO_10 direction as OUTPUT*/
   sl_si91x_gpio_set_pin_direction(4, 10, 0);

```

## Digital Functions for Virtual SoC GPIO's 

From the above table each and every ULP_GPIO can be configured as SoC GPIO using ULP MODE register. The SoC GPIOs below (SOCPERH_ON_ULP_GPIO_0 to SOCPERH_ON_ULP_GPIO_11) are available in the normal mode of operation (Power-states 4 and 3). For a description of power-states, refer to the Hardware Reference Manual. Each of these GPIO's Pin function is controlled by the GPIO Mode register mentioned in SoC GPIO's section of the Hardware Reference Manual.

| **PIN** | **PAD NUMBER** | **GPIO** | **GPIO Mode= 0** | **GPIO Mode= 1** | **GPIO Mode= 2** | **GPIO Mode= 3** | **GPIO Mode= 4** | **GPIO Mode= 5** | **GPIO Mode= 6** | **GPIO Mode= 7** | **GPIO Mode= 8** | **GPIO Mode= 9** | **GPIO Mode= 10** | **GPIO Mode= 11** | **GPIO Mode= 12** | **GPIO Mode*= 13** |
| ------- | -------------- | ---------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | --------------------- | -------------------------- | -------------------------- | -------------------------- | -------------------------- |
| 64      | 22             | SOCPERH_ON_ULP_GPIO_0  | GPIO_64               | SIO_0                 | USART1_CLK            | QEI_IDX               | I2C1_SDA              | I2C2_SCL              | UART2_RS485_EN        | SCT_IN_0              | PWM_1L                | UART2_RTS             |                            | USART1_IR_RX               | PWM_1L                     | PMU_TEST_1                 |
| 65      | 23             | SOCPERH_ON_ULP_GPIO_1  | GPIO_65               | SIO_1                 | USART1_RX             | QEI_PHA               | I2C1_SCL              | I2C2_SDA              | UART2_RS485_RE        | SCT_IN_1              | PWM_1H                | UART2_CTS             |                            | USART1_IR_TX               | PWM_1H                     | PMU_TEST_2                 |
| 66      | 24             | SOCPERH_ON_ULP_GPIO_2  | GPIO_66               | SIO_2                 |                       | QEI_PHB               | I2C1_SCL              | I2C2_SCL              | UART2_RS485_DE        | SCT_IN_2              | PWM_2L                | UART2_RX              | PMU_TEST_1                 |                            |                            |                            |
| 67      | 25             | SOCPERH_ON_ULP_GPIO_3  | GPIO_67               | SIO_3                 |                       | QEI_DIR               | I2C1_SDA              | I2C2_SDA              |                       | SCT_IN_3              | PWM_2H                | UART2_TX              | PMU_TEST_2                 |                            |                            |                            |
| 68      | 26             | SOCPERH_ON_ULP_GPIO_4  | GPIO_68               | SIO_4                 | USART1_TX             | QEI_IDX               |                       |                       | UART2_RX              | SCT_OUT_0             | PWM_3L                | SCT_IN_0              | PWM_FAULTA                 | USART1_RI                  | PWM_2L                     | SCT_OUT_4                  |
| 69      | 27             | SOCPERH_ON_ULP_GPIO_5  | GPIO_69               | SIO_5                 | USART1_RTS            | QEI_PHA               |                       |                       | UART2_TX              | SCT_OUT_1             | PWM_3H                | SCT_IN_1              | PWM_FAULTB                 | USART1_RS485_EN            | PWM_2H                     | SCT_OUT_5                  |
| 70      | 28             | SOCPERH_ON_ULP_GPIO_6  | GPIO_70               | SIO_6                 | USART1_CTS            | QEI_PHB               | USART1_RX             | I2C2_SCL              | UART2_RTS             | SCT_OUT_2             | PWM_4L                | SCT_IN_2              | PWM_TMR_EXT_TRIG_1         | USART1_RS485_RE            | PMU_TEST_1                 | SCT_OUT_6                  |
| 71      | 29             | SOCPERH_ON_ULP_GPIO_7  | GPIO_71               | SIO_7                 | USART1_IR_RX          | QEI_DIR               | USART1_TX             | I2C2_SDA              | UART2_CTS             | SCT_OUT_3             | PWM_4H                | SCT_IN_3              | PWM_TMR_EXT_TRIG_2         | USART1_RS485_DE            | PMU_TEST_2                 | SCT_OUT_7                  |
| 72      | 30             | SOCPERH_ON_ULP_GPIO_8  | GPIO_72               | SIO_0                 | USART1_IR_TX          | QEI_IDX               |                       |                       | UART2_RX              | SCT_OUT_4             | PWM_SLP_EVENT_TRIG    | UART2_RTS             | PWM_TMR_EXT_TRIG_3         |                            |                            |                            |
| 73      | 31             | SOCPERH_ON_ULP_GPIO_9  | GPIO_73               | SIO_1                 | USART1_RS485_EN       | QEI_PHA               |                       |                       | UART2_TX              | SCT_OUT_5             | PWM_FAULTA            | UART2_CTS             | PWM_TMR_EXT_TRIG_4         |                            |                            |                            |
| 74      | 32             | SOCPERH_ON_ULP_GPIO_10 | GPIO_74               | SIO_2                 | USART1_RS485_RE       | QEI_PHB               | I2C1_SDA              |                       | UART2_RS485_RE        | SCT_OUT_6             | PWM_FAULTB            | UART2_RX              | PMU_TEST_1                 |                            |                            |                            |
| 75      | 33             | SOCPERH_ON_ULP_GPIO_11 | GPIO_75               | SIO_3                 | USART1_RS485_DE       | QEI_DIR               | I2C1_SCL              |                       | UART2_RS485_DE        | SCT_OUT_7             | PWM_TMR_EXT_TRIG_1    | UART2_TX              | PMU_TEST_2                 |                            |                            |                            |


## Memory Organization
This section provides an overview of the different memory regions of the SiWx917 SoC,

**SiWx917 SoC** is equipped with various memory components. 

* On-chip SRAM of 192K/256K/320 Kbytes based on the chip configuration
* 8Kbytes is present in the Ultra-low-power peripheral subsystem, primarily used by the ULP MCU peripherals
* 64Kbytes of ROM
* Quad SPI flash up to 4MBytes based on the package configuration
* Quad SPI PSRAM up to 2MBytes based on the package configuration
* eFuse of 32 bytes
For detailed information on above memory components, refer to **SiWx917 Memory Organization App note**.


## Flash and PSRAM combinations
This section briefs of various available package combinations of Flash and PSRAM.

Based on the use application and use-cases, appropriate Flash and PSRAM combination can be selected. 

* In Common flash variant, Both NWP and MCU will use the same Flash. There is an option to attach the PSRAM
* In Dual flash variant, the NWP and MCU will have their own flash regions. Staked flash is dedicated to TA in this variant and the external flash for MCU. There is an option to attach the PSRAM

The table shows the possible combinations:

| **Modes**    | **Flash type**                           | **Flash Size**            | **PSRAM (optional)**                    |
| ------------ | ---------------------------------------- | ------------------------- | --------------------------------------- |
| Common Flash | **Stacked**                              | 4MB                       | 2MB    8MB **Note:** Should be External |
|              | **External** (No Internal Stacked flash) | 8MB                  16MB | Stacked 2MB                         8MB |
| Dual Flash   | **Stacked + External**                   | 4MB + 8MB      4MB + 16MB | 2MB                                 8MB |

Refer to OPN Section in datasheet for more information.

## Chip/Module Programming

## In System Programming Mode
SiWx917 SoC can be configured to be in programming mode. This is achieved using a asserting GPIO_34. Upon this pin assertion and resetting, the module will be put into ISP mode.

In System Programming(ISP) is programming or reprogramming of the flash via Security bootloader. Security Bootloader can be requested to boot in ISP mode by pulling down the GPIO_34 pin with 4.7K ohms of resistor. This pin has to be left unconnected during reset for the bootloader to bypass ISP and execute the code that is present in flash. ISP mode can be used to reprogram the flash, if the application code uses JTAG pins for functional use. On boot up, if the application code goes into a state where JTAG interface is not functioning, ISP mode can be used to gain the control and to reprogram the flash.

ISP is supported via following interfaces,

| **Interface** |         **Pins**          |
|---------------| --------------------------|
| **UART**      | RX: GPIO_8     TX: GPIO_9 |
| **SDIO**      | GPIO_25 - GPIO_30         |
| **HSPI**      | GPIO_25 - GPIO_30         |

## Trace and Debug Interfaces
Trace and Debug functions are integrated into the ARM Cortex-M4. The Cortex-M4 TPIU supports two output modes:

* Clocked mode, using up to 4-bit parallel data output ports
* SWV mode, using single-bit SWV output

**Note:** Trace and Debug component need CLK supply on **M4SS_TRACE_CLKIN pin**

![Trace and Debug Interfaces](./resources/trace_debug_interface.png)

**Note:** This will be supported on Radio Board BRD4338A

## Serial Wire Viewer (SWV) Support
The SWV provides real-time data trace information from various sources within a Cortex-M4 device. It is transmitted via the **SWO** pin while your system processor continues to run at full speed. Information is available from the ITM and DWT units. SWV data trace is available via the SWO pin. 

**Setup:** Configure GPIO_12 pin in Mode 8 (MCU_CLK_OUT) and connect to back to GPIO_15 pin configured in GPIO Mode 6 (M4SS_TRACE_CLKIN). The MCU_CLK_OUT has programmable divider option from MCU clock. The MCU_CLK_OUT frequency must be less than 40Mhz to use the SWO function. By following the configurations data trace can be observed with the supporting debug probes.

MCU_CLK_OUT register details are present in 'SiWx917 MCU HP Clock Architecture > MCUHP_CLK_CONFIG_REG3 ' in **SiWx917 Hardware Reference Manual**.

## Embedded Trace Macrocell (ETM) Support
The ETM provides high bandwidth instruction trace via four dedicated trace pins accessible on the 20-pin Cortex Debug + ETM connector. The MCU_CLK_OUT frequency must be in the range of 40Mhz to 90MHz to Instruction trace using ETM component.

**Setup:** Configure Trace pins (GPIO_52 to GPIO_57) in Mode 6 and GPIO_12 pin in Mode 8 (MCU_CLK_OUT). By default on power up these GPIO pins are mapped to Cortex Debug + ETM connector (20-pin). By following the configurations Instruction trace can be observed with the supporting debug probes.

**Note:** Free running clock should be present on MCU_CLK_OUT (GPIO_12), before programming Trace pins otherwise IDE will popup **Trace HW not present** error.

**Note:** Above mentioned details are applicable for Radio Board BRD4338A onwards

## VCOM
The VCOM port available on main board (4002A) supports following features,

* Flash, Erase and Debug SiWx917 MCU over SWD
* Provides SiWx917 MCU UART RX and TX capabilities. This enables usage of any CLI based applications and debug prints
  * In this mode, ULP_GPIO_2 (RX) and ULP_GPIO_11 (TX) will be mapped to M4 UART
* Support flash programming via ISP
  * In this mode, GPIO_8 (RX) and GPIO_9 (TX) will be mapped to TA UART


**Note:** Debug logs from Wireless core can be fetched via TA UART which is available on EXP header, EXP14 (UART_RX) and EXP12(UART_TX)

**Note:** Above mentioned details are applicable for Radio Board BRD4338A


## Front End Switch selection GPIO 
 Front End Switch GPIO pin selection configured through opermode.

![ Front End Switch selection GPIO](./resources/frontend-switch-selections.png)

**Note:** VC1, VC2 and VC3 are control voltage pins of RF Switch. For more details please refer Reference Schematics.